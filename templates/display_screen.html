<!DOCTYPE html>
<html>
<head>
    <title>Display - {{ screen_name }}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            height: 100vh;
            overflow: hidden;
            border: 10px solid #333;
            box-sizing: border-box;
        }
        body.timer-recent {
            border-color: #4CAF50;
        }
        body.timer-warning {
            border-color: #ff9800;
        }
        body.timer-alert {
            border-color: #f44336;
            animation: border-pulse 2s infinite;
        }
        @keyframes border-pulse {
            0%, 100% { border-color: #f44336; }
            50% { border-color: #ff6b6b; }
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 1px;
            height: 1px;
            overflow: hidden;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }
        .screen-name-header {
            color: #4CAF50;
            font-family: 'Consolas', monospace;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        .input-container {
            display: flex;
            gap: 8px;
        }
        .input-container input[type="text"] {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            width: 250px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .input-container input[type="text"]:focus {
            outline: none;
            border-color: #45a049;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        .input-container button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #45a049;
        }
        .info-bar {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.85);
            padding: 15px 30px;
            z-index: 100;
            border-top: 4px solid #333;
            border-bottom: 4px solid #333;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            transition: border-color 0.3s ease;
        }
        body.timer-recent .info-bar {
            border-top-color: #4CAF50;
            border-bottom-color: #4CAF50;
        }
        body.timer-warning .info-bar {
            border-top-color: #ff9800;
            border-bottom-color: #ff9800;
        }
        body.timer-alert .info-bar {
            border-top-color: #f44336;
            border-bottom-color: #f44336;
        }
        .screen-title {
            color: #4CAF50;
            font-family: 'Consolas', monospace;
            font-size: 36px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            letter-spacing: 1px;
            transition: color 0.3s ease;
        }
        body.timer-recent .screen-title {
            color: #4CAF50;
        }
        body.timer-warning .screen-title {
            color: #ff9800;
        }
        body.timer-alert .screen-title {
            color: #fff;
        }
        .image-name-display {
            color: #4CAF50;
            font-family: 'Consolas', monospace;
            font-size: 32px;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.9);
            display: none;
            letter-spacing: 1px;
            text-align: center;
            flex: 1;
            margin: 0 30px;
            transition: color 0.3s ease;
        }
        body.timer-recent .image-name-display {
            color: #4CAF50;
        }
        body.timer-warning .image-name-display {
            color: #ff9800;
        }
        body.timer-alert .image-name-display {
            color: #fff;
        }
        .timer-display {
            color: #fff;
            font-family: 'Consolas', monospace;
            font-size: 48px;
            font-weight: bold;
            padding: 10px 30px;
            border-radius: 10px;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            letter-spacing: 2px;
            text-align: right;
            background-color: rgba(0, 0, 0, 0.9);
            transition: all 0.3s ease;
        }
        .timer-display.recent {
            border-color: #4CAF50;
            color: #4CAF50;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
        }
        .timer-display.warning {
            border-color: #ff9800;
            color: #ff9800;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.6);
        }
        .timer-display.alert {
            border-color: #f44336;
            color: #fff;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.6);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .container {
            text-align: center;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-top: 100px;
            padding-bottom: 20px;
            box-sizing: border-box;
        }
        img {
            max-width: calc(100vw - 30px);
            max-height: calc(100vh - 160px);
            width: auto;
            height: auto;
            object-fit: contain;
            display: none;
        }
        .placeholder {
            color: #666;
            font-family: Arial, sans-serif;
            font-size: 20px;
        }
        .error {
            color: #ff4444;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="screen-name-header">{{ screen_name }}</h1>
        <form class="input-container" onsubmit="submitImage(); return false;">
            <input 
                type="text" 
                id="image-input" 
                placeholder="Enter image name..."
                autofocus
                autocomplete="off"
            >
            <button type="submit">Display</button>
        </form>
    </div>
    
    <div class="info-bar">
        <div class="screen-title">{{ screen_name }}</div>
        <div class="image-name-display" id="image-name-display"></div>
        <div class="timer-display" id="timer-display">--:--:--</div>
    </div>
    
    <div class="container">
        <div class="placeholder" id="placeholder">Waiting for image...</div>
        <div class="error" id="error" style="display: none;"></div>
        <img id="display-image" alt="Display">
    </div>

    <script>
        const socket = io();
        const screenName = '{{ screen_name }}';
        const displayImage = document.getElementById('display-image');
        const placeholder = document.getElementById('placeholder');
        const errorDiv = document.getElementById('error');
        const imageInput = document.getElementById('image-input');
        const imageNameDisplay = document.getElementById('image-name-display');
        const timerDisplay = document.getElementById('timer-display');

        let lastScanTime = null;
        let timerInterval = null;
        
        // Get timing thresholds from config
        const WARNING_TIME = {{ timing.warning }};
        const OVER_TIME = {{ timing.over }};

        // Format time elapsed
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return `${hours}h ${minutes}m ${secs}s`;
            } else if (minutes > 0) {
                return `${minutes}m ${secs}s`;
            } else {
                return `${secs}s`;
            }
        }

        // Update timer display
        function updateTimer() {
            if (!lastScanTime) {
                timerDisplay.textContent = '--:--:--';
                timerDisplay.className = 'timer-display';
                return;
            }

            const elapsed = Math.floor((Date.now() - lastScanTime) / 1000);
            timerDisplay.textContent = formatTime(elapsed);

            // Color coding based on configured time thresholds
            // Remove all timer classes from body
            document.body.classList.remove('timer-recent', 'timer-warning', 'timer-alert');
            
            if (elapsed < WARNING_TIME) {
                timerDisplay.className = 'timer-display recent';
                document.body.classList.add('timer-recent');
            } else if (elapsed < OVER_TIME) {
                timerDisplay.className = 'timer-display warning';
                document.body.classList.add('timer-warning');
            } else {
                timerDisplay.className = 'timer-display alert';
                document.body.classList.add('timer-alert');
            }
        }

        // Start timer
        function startTimer() {
            console.log('Starting timer...');
            lastScanTime = Date.now();
            if (timerInterval) {
                clearInterval(timerInterval);
            }
            updateTimer(); // Update immediately
            timerInterval = setInterval(updateTimer, 1000);
        }

        // Auto-focus input on page load
        window.addEventListener('load', () => {
            imageInput.focus();
        });

        // Always keep input focused - critical for barcode scanning
        function ensureFocus() {
            if (document.activeElement !== imageInput) {
                imageInput.focus();
            }
        }

        // Refocus on blur (when input loses focus)
        imageInput.addEventListener('blur', () => {
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        // Refocus on any click anywhere on the page
        document.addEventListener('click', (e) => {
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });// Start/reset timer
            startTimer();
            
            

        // Refocus on any key press
        document.addEventListener('keydown', (e) => {
            if (document.activeElement !== imageInput) {
                imageInput.focus();
            }
        });

        // Periodically check and refocus (safety net for barcode scanners)
        setInterval(ensureFocus, 100);

        function submitImage() {
            const imageName = imageInput.value.trim();
            
            console.log('Submit clicked, image name:', imageName);
            
            if (!imageName) {
                console.log('No image name provided');
                imageInput.focus();
                return;
            }

            console.log('Emitting manual_submit event');
            socket.emit('manual_submit', {
                screen_name: screenName,
                image_name: imageName
            });

            // Clear input and refocus
            imageInput.value = '';
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        }

        // Join the room for this screen
        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('join', { screen_name: screenName });
            imageInput.focus();
        });

        socket.on('joined', (data) => {
            console.log('Joined room:', data.screen_name);
        });

        socket.on('update_image', (data) => {
            console.log('Received image update:', data);
            
            // Start/reset timer on new image
            startTimer();
            
            placeholder.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Update image name display
            imageNameDisplay.textContent = data.image_name;
            imageNameDisplay.style.display = 'inline-block';
            
            // Add cache-busting parameter
            const imageUrl = data.image_url + '?t=' + new Date().getTime();
            
            displayImage.src = imageUrl;
            displayImage.style.display = 'block';
            
            displayImage.onerror = () => {
                displayImage.style.display = 'none';
                imageNameDisplay.style.display = 'none';
                errorDiv.textContent = 'Failed to load image: ' + data.image_name;
                errorDiv.style.display = 'block';
            };
            
            // Refocus input after image loads
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            placeholder.textContent = 'Connection lost. Reconnecting...';
            placeholder.style.display = 'block';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            errorDiv.textContent = 'Connection error';
            errorDiv.style.display = 'block';
        });

        socket.on('error', (data) => {
            console.error('Socket error:', data);
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
            placeholder.style.display = 'none';
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        socket.on('success', (data) => {
            console.log('Socket success:', data);
        });
    </script>
</body>
</html>
