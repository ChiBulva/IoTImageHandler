<!DOCTYPE html>
<html>
<head>
    <title>Display - {{ screen_name }}</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow: hidden;
        }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.9);
            padding: 8px 15px;
            z-index: 101;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 50px;
            box-sizing: border-box;
        }
        .screen-name-header {
            color: #4CAF50;
            font-family: Arial, sans-serif;
            font-size: {{ config.get('screen_name_size', '20px') }};
            font-weight: bold;
            margin: 0;
        }
        .input-container {
            display: flex;
            gap: 8px;
        }
        .input-container input[type="text"] {
            padding: 8px 12px;
            font-size: 14px;
            border: 2px solid #4CAF50;
            border-radius: 4px;
            width: 250px;
            background-color: rgba(255, 255, 255, 0.95);
        }
        .input-container input[type="text"]:focus {
            outline: none;
            border-color: #45a049;
            box-shadow: 0 0 8px rgba(76, 175, 80, 0.5);
        }
        .input-container button {
            padding: 8px 16px;
            font-size: 14px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #45a049;
        }
        .image-name-display {
            position: fixed;
            top: 50px;
            left: 0;
            right: 0;
            text-align: center;
            color: #4CAF50;
            font-family: Arial, sans-serif;
            font-size: {{ config.get('image_name_size', '18px') }};
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 100;
            display: none;
            padding: 6px;
            background-color: rgba(0, 0, 0, 0.8);
            height: 35px;
            line-height: 35px;
        }
        .container {
            text-align: center;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-top: 85px;
            box-sizing: border-box;
        }
        img {
            max-width: {{ config.get('max_image_width', '98vw') }};
            max-height: {{ config.get('max_image_height', 'calc(100vh - 120px)') }};
            width: auto;
            height: auto;
            object-fit: contain;
            display: none;
        }
        .placeholder {
            color: #666;
            font-family: Arial, sans-serif;
            font-size: 20px;
        }
        .error {
            color: #ff4444;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="screen-name-header">{{ screen_name }}</h1>
        <form class="input-container" onsubmit="submitImage(); return false;">
            <input 
                type="text" 
                id="image-input" 
                placeholder="Enter image name..."
                autofocus
            >
            <button type="submit">Display</button>
        </form>
    </div>
    
    <div class="image-name-display" id="image-name-display"></div>
    
    <div class="container">
        <div class="placeholder" id="placeholder">Waiting for image...</div>
        <div class="error" id="error" style="display: none;"></div>
        <img id="display-image" alt="Display">
    </div>

    <script>
        const socket = io();
        const screenName = '{{ screen_name }}';
        const displayImage = document.getElementById('display-image');
        const placeholder = document.getElementById('placeholder');
        const errorDiv = document.getElementById('error');
        const imageInput = document.getElementById('image-input');
        const imageNameDisplay = document.getElementById('image-name-display');

        // Auto-focus input on page load
        window.addEventListener('load', () => {
            imageInput.focus();
        });

        // Always keep input focused - critical for barcode scanning
        function ensureFocus() {
            if (document.activeElement !== imageInput) {
                imageInput.focus();
            }
        }

        // Refocus on blur (when input loses focus)
        imageInput.addEventListener('blur', () => {
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        // Refocus on any click anywhere on the page
        document.addEventListener('click', (e) => {
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        // Refocus on any key press
        document.addEventListener('keydown', (e) => {
            if (document.activeElement !== imageInput) {
                imageInput.focus();
            }
        });

        // Periodically check and refocus (safety net for barcode scanners)
        setInterval(ensureFocus, 100);

        function submitImage() {
            const imageName = imageInput.value.trim();
            
            console.log('Submit clicked, image name:', imageName);
            
            if (!imageName) {
                console.log('No image name provided');
                imageInput.focus();
                return;
            }

            console.log('Emitting manual_submit event');
            socket.emit('manual_submit', {
                screen_name: screenName,
                image_name: imageName
            });

            // Clear input and refocus
            imageInput.value = '';
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        }

        // Join the room for this screen
        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('join', { screen_name: screenName });
            imageInput.focus();
        });

        socket.on('joined', (data) => {
            console.log('Joined room:', data.screen_name);
        });

        socket.on('update_image', (data) => {
            console.log('Received image update:', data);
            
            placeholder.style.display = 'none';
            errorDiv.style.display = 'none';
            
            // Update image name display
            imageNameDisplay.textContent = data.image_name;
            imageNameDisplay.style.display = 'block';
            
            // Add cache-busting parameter
            const imageUrl = data.image_url + '?t=' + new Date().getTime();
            
            displayImage.src = imageUrl;
            displayImage.style.display = 'block';
            
            displayImage.onerror = () => {
                displayImage.style.display = 'none';
                imageNameDisplay.style.display = 'none';
                errorDiv.textContent = 'Failed to load image: ' + data.image_name;
                errorDiv.style.display = 'block';
            };
            
            // Refocus input after image loads
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            placeholder.textContent = 'Connection lost. Reconnecting...';
            placeholder.style.display = 'block';
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            errorDiv.textContent = 'Connection error';
            errorDiv.style.display = 'block';
        });

        socket.on('error', (data) => {
            console.error('Socket error:', data);
            errorDiv.textContent = data.message;
            errorDiv.style.display = 'block';
            placeholder.style.display = 'none';
            setTimeout(() => {
                imageInput.focus();
            }, 10);
        });

        socket.on('success', (data) => {
            console.log('Socket success:', data);
        });
    </script>
</body>
</html>
